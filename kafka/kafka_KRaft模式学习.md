### Kafka KRaft模式

Apache Kafka是一个事件流平台，它结合了三个关键功能，因此可以使用一个经过实战检验的解决方案来实现端到端事件流的应用场景。
1. 发布（写入）和订阅（读取）事件流，包括从其他系统持续导入、导出数据。
2. 根据需要持久可靠地存储事件流。
3. 在事件发生时或回顾性地处理事件流。
所有这些功能都是以分布式、高度可扩展、弹性、容错和安全的方式提交的。Kafka可以部署在裸机硬件、虚拟机和容器上，也可以部署在本地和云端。可以选择自行管理Kafka环境，也可以选择使用各种供应商提供的完全托管服务。简而言之，Kafka是一个分布式系统，由通过高性能TCP网络协议进行通信的服务器和客户端组成。
1. 服务器：Kafka部署在一台或多台服务器以集群方式运行，可以跨多个数据中心或云区域。Kafka集群具有高度可扩展性和容错性：如果其中任何服务器发生故障，其他服务器将接管其工作，以确保连续运行而不丢失任务数据。
2. 客户端：Kafka社区提供数十个客户端进行了扩充，客户端可用于Java、Scala，包括更高级别的Kafka Steams库，适用于Go、Python、C/C++和许多其他编程语言以及REST API。

##### 主要概念和术语

* 事件：事件记录了世界上或企业中发生了一些事情的事实。在文档中也被称为消息。向Kafka读取和写入数据时，以事件的形式执行此操作。从概念上讲，事件具有键、值、时间戳和可选的元数据标头。
* 生产者：将事件发布到Kafka的客户端应用程序，而消费者是订阅这些事件的客户端应用程序。在Kafka中，生产者和消费者彼此完全解耦，这是实现Kafka闻名的高可扩展性地关键设计元素。
* 主题：事件被组织并持久存储在主题中。简单的理解为主题是文件系统中的文件夹，而事件则是文件系统中的文件。Kafka中的主题始终是多生产者和多订阅者：一个主题可以有零个、一个或多个向其写入事件的生产者，以及零个、一个或多个订阅这些事件的消费者。主题中的事件可以根据需要随时读取，与传统消息传递系统不同，事件在使用后不会被删除。相反，可以通过每个主题的配置设置来定义kafka应保留事件的时间，之后旧事件将被丢弃。Kafka的性能在数据大小方面实际上是恒定的，因此长时间存储数据是完全可以的。
* 分区：一个主题分布在多个不同Kafka代理上的多个桶中。这种数据分布式放置对于可扩展性非常重要，因为它允许客户端应用程序同时从多个代理读取数据或向多个代理写入数据。新的事件发布到主题时，它实际上会附加到主题的分区之一。具有相同事件键的事件被写入同一分区，并且Kafka保证给定主题分区的任何消费者将始终按照与写入的顺序完全相同的顺序读取该分区的事件。
* 复制：每个主题都可以复制，甚至可以跨地理区域或数据中心进行复制，因此始终有多个代理拥有数据副本，使集群中的数据具有容错性和高可用性。常见的生产设置复制因子为3，既始终存在数据的三个副本。

##### KRaft集群

Kafka集群的KRaft模式中包含两个集群，一个是broker集群还有一个是controller集群。broker集群是Kafka集群的存储层，而controller集群则是Kafka集群的管理层，controller集群中存储着Kafka集群中的元数据。可以简单地理解controller集群是管理着Kafka集群的集群，提供分布式共识服务。

###### KRaft集群中的重要配置项

1. Broker的重要配置：
* node id: 配置节点的ID，在集群里的唯一ID；
* process roles：节点类型，Broker集群中roles的值为broker；
* controller quorum voters：配置所有的controller节点，controller节点管理着集群的元数据信息；
* listenser: 配置KRaft集群中Broker的监听器，该监听器用于监听Kafka客户端的请求。配置语法为：监听器名：//ip或者域名：端口号，可以配置多个监听器使用`,`分隔；
* advertise listenser: 配置广播监听器，该监听器用于将本Broker的endpoint信息发布到整个集群中，方便后续客户端使用endpoint来访问Broker。配置语法为监听器名：//ip或者域名：端口号，如果不设置默认使用listener作为广播监听器，多个使用`，`分隔；
* inter broker listener name：配置Broker集群内部相互通信的listener；
* listener protocal map：配置监听器的协议，配置语法为监听器：协议名。现在Kafka支持的协议有PLAINTEXT(明文传输)、SSL(SSL加密传输)、SASL_PLAINTEXT(身份验证明文传输)、SASL_SSL(身份验证密文传输)；
* log dirs：Broker的数据目录，存储着Broker集群中的所有持久化数据。

2. Controller的重要配置：
* node id: 配置节点的ID，在集群里的唯一ID；
* process roles：节点类型，Controller集群中roles的值为controller；
* controller quorum voters：配置所有的controller节点，controller节点管理着集群的元数据信息；
* listeners：controller节点的监听器,同Broker节点一样可以配置多个监听器；
* log dirs：Controller的数据目录，存储着Controller集群中的所有持久化数据。

##### Kafka的主题、分区和副本





